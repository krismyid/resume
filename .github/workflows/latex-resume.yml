name: Build and Release LaTeX Resume

on:
  push:
    branches:
      - main
    paths:
      - 'resume.tex'
      - '.github/workflows/latex-resume.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-latex-resume:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup LaTeX environment
        uses: xu-cheng/latex-action@v3
        with:
          root_file: resume.tex
          latexmk_use_xelatex: false
          latexmk_use_lualatex: false
          working_directory: .
          
      - name: Compile Motivation Letter
        uses: xu-cheng/latex-action@v3
        with:
          root_file: motivation-letter.tex
          latexmk_use_xelatex: false
          latexmk_use_lualatex: false
          working_directory: .
          
      - name: Verify PDF generation
        run: |
          if [ -f "resume.pdf" ]; then
            echo "‚úÖ Resume PDF generated successfully"
            ls -la resume.pdf
            echo "Resume PDF size: $(du -h resume.pdf | cut -f1)"
          else
            echo "‚ùå Resume PDF generation failed"
            exit 1
          fi
          
          if [ -f "motivation-letter.pdf" ]; then
            echo "‚úÖ Motivation Letter PDF generated successfully"
            ls -la motivation-letter.pdf
            echo "Motivation Letter PDF size: $(du -h motivation-letter.pdf | cut -f1)"
          else
            echo "‚ùå Motivation Letter PDF generation failed"
            exit 1
          fi
          
      - name: Rename PDFs to unique filenames
        run: |
          mv resume.pdf "Christian_Windi_Utomo_DevOps_SRE_Resume.pdf"
          mv motivation-letter.pdf "Christian_Windi_Utomo_Motivation_Letter.pdf"
          echo "üìÑ Resume PDF renamed to: Christian_Windi_Utomo_DevOps_SRE_Resume.pdf"
          echo "üìÑ Motivation Letter PDF renamed to: Christian_Windi_Utomo_Motivation_Letter.pdf"
          ls -la "Christian_Windi_Utomo_DevOps_SRE_Resume.pdf"
          ls -la "Christian_Windi_Utomo_Motivation_Letter.pdf"
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          tag_name: resume-v${{ github.run_number }}
          name: Resume v${{ github.run_number }} - ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
          body: |
            ## LaTeX Resume PDF
            
            **Generated on:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            ### Changes in this version:
            ${{ github.event.head_commit.message }}
            
            ### What's included:
            - Professional ATS-compliant resume in PDF format
            - Optimized for DevOps Engineer and SRE positions
            - Clean, professional formatting
            
            ---
            
            *This PDF was automatically generated from LaTeX source on GitHub Actions.*
            
          files: |
            Christian_Windi_Utomo_DevOps_SRE_Resume.pdf
            Christian_Windi_Utomo_Motivation_Letter.pdf
            resume.tex
            motivation-letter.tex
          
      - name: Success notification
        run: |
          echo "üéâ Documents successfully built and released!"
          echo "üìÑ Resume PDF: Christian_Windi_Utomo_DevOps_SRE_Resume.pdf"
          echo "üìÑ Motivation Letter PDF: Christian_Windi_Utomo_Motivation_Letter.pdf"
          echo "üè∑Ô∏è  Release tag: resume-v${{ github.run_number }}"
          echo "üìä Resume size: $(du -h Christian_Windi_Utomo_DevOps_SRE_Resume.pdf | cut -f1)"
          echo "üìä Motivation Letter size: $(du -h Christian_Windi_Utomo_Motivation_Letter.pdf | cut -f1)"
          echo "üîó Check releases page for download links" 